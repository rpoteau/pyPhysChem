#!/bin/bash

set -e  # exit on any error

# --- COLORS DEFINITION ---
NC='\033[0m'              # No Color (Reset)
BOLD='\033[1m'
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BCYAN="${BOLD}${CYAN}"
BGREEN="${BOLD}${GREEN}"

if [ -n "$1" ]; then
    echo "---------------------------------------------------------------"
    echo -e "âœ… commit message = ${BOLD}$1${NC}"
else
    echo -e "${RED}âŒ commit message must be given as a parameter of this git_push command${NC}"
    echo "exit"
    exit 1
fi

# --- SEMANTIC VERSIONING ENGINE ---
# Retrieve the latest tag from git history
last_tag=$(git describe --tags --abbrev=0 2>/dev/null | xargs || echo "2.3.0")

# Strip 'v' prefix if exists
clean_version=$(echo "$last_tag" | sed 's/^v//')

# Extract major, minor, and patch components
major=$(echo $clean_version | cut -d. -f1)
minor=$(echo $clean_version | cut -d. -f2)
patch=$(echo $clean_version | cut -d. -f3)

echo -e "ðŸ“ˆ Last version detected: ${BCYAN}$clean_version${NC}"

# Prompt the user to choose the increment type
echo -e "${BOLD}What type of update is this?${NC}"
select opt in "Patch (x.x.X)" "Minor (x.X.0)" "Major (X.0.0)" "Skip Tagging"; do
    case $opt in
        "Patch (x.x.X)")
            new_version="$major.$minor.$((patch + 1))"
            break
            ;;
        "Minor (x.X.0)")
            new_version="$major.$((minor + 1)).0"
            break
            ;;
        "Major (X.0.0)")
            new_version="$((major + 1)).0.0"
            break
            ;;
        "Skip Tagging")
            new_version=""
            break
            ;;
        *) echo "Invalid option $REPLY";;
    esac
done

# Check if the new tag already exists locally
if [ -n "$new_version" ]; then
    if git rev-parse "$new_version" >/dev/null 2>&1; then
        echo "---------------------------------------------------------------"
        echo -e "${YELLOW}âš ï¸  Error: Tag '$new_version' already exists!${NC}"
        echo "Please delete it manually or choose a different update type."
        echo "---------------------------------------------------------------"
        exit 1
    fi
fi

if [ -n "$new_version" ]; then
    echo -e "ðŸš€ Next version: ${BGREEN}$new_version${NC}"
fi

echo "---------------------------------------------------------------"
echo -e "${BOLD}First finding if there are large files in [sub]folders${NC}"
find . -path ./.git -prune -o -size +49M -print | sed 's|^\./||' > .LargeFiles
/bin/cp .gitignore .gitignore.bak
cat .gitignore_base .LargeFiles > .gitignore
echo "---------------------------------------------------------------"
echo -e "${BOLD}now processing git status${NC}"
git status
echo "---------------------------------------------------------------"

while true; do
    echo -ne "${YELLOW}${BOLD}Do you wish to add > commit > push? (y/n) ${NC}"
    read yn
    case $yn in
        [Yy]* )
            echo "---------------------------------------------------------------"
            git add --all
            git status
            git commit -m "$1"
            
            if [ -n "$new_version" ]; then
                # Create a local tag with the commit message
                git tag -a "$new_version" -m "$1"
                # Push both the branch and the specific tag to origin
                git push origin main
                git push origin "$new_version"
                echo -e "${BGREEN}âœ… Successfully pushed $new_version to GitHub${NC}"
            else
                git push origin main
                echo -e "${GREEN}âœ… Pushed to main without new tag${NC}"
            fi
            break
            ;;
        [Nn]* )
            exit
            ;;
        * )
            echo "Please answer yes (y) or no (n)."
            ;;
    esac
done
